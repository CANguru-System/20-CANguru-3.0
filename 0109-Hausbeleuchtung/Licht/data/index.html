<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>Arduino Steuerung</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 30px;
    }

    .container {
      background-color: #fff;
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 25px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .dropdown-group {
      display: flex;
      align-items: center;
      flex: 1;
      margin-right: 15px;
    }

    .dropdown-group:last-child {
      margin-right: 0;
    }

    label {
      min-width: 120px;
      font-weight: bold;
    }

    select {
      width: 66%;
      padding: 6px;
      font-size: 15px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-group label {
      font-weight: normal;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #0078D7;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #005fa3;
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 25px 0;
      font-weight: bold;
      color: #555;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      border-bottom: 2px solid #ccc;
      margin: 0 10px;
    }

    .ip-info {
      font-weight: bold;
      color: #444;
      margin-bottom: 40px;
    }

    select:disabled {
      background-color: #eee;
      color: #888;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Hausbeleuchtung Version 1.0</h2>
    <p id="ipDisplay" class="ip-info"></p>

    <!-- Zeile 1 -->
    <div class="row">
      <div class="dropdown-group"><label for="d1">Raum:</label><select id="d1"></select></div>
      <div class="dropdown-group"><label for="d2">onTime:</label><select id="d2"></select></div>
      <div class="dropdown-group"><label for="d3">offtime:</label><select id="d3"></select></div>
    </div>

    <div class="divider">Farbe für alle Felder</div>

    <!-- Zeile 2 -->
    <div class="row">
      <div class="dropdown-group"><label for="d4">Rot:</label><select id="d4"></select></div>
      <div class="dropdown-group"><label for="d5">Grün:</label><select id="d5"></select></div>
      <div class="dropdown-group"><label for="d6">Blau:</label><select id="d6"></select></div>
    </div>

    <div class="divider">für alle Felder</div>

    <!-- Zeile 3 -->
    <div class="row">
      <div class="dropdown-group"><label for="d7">Zeitfaktor:</label><select id="d7"></select></div>
      <div class="dropdown-group"><label for="d8">genutzte LED:</label><select id="d8"></select></div>
    </div>

    <!-- Radiobuttons + Button -->
    <div class="controls">
      <div class="radio-group">
        <label><input type="radio" name="modus" value="Mode 1"> Hausbeleuchtung</label>
        <label><input type="radio" name="modus" value="Mode 2"> Effekte</label>
        <label><input type="radio" name="modus" value="Mode 3"> Test</label>
      </div>
      <button onclick="speichereKonfiguration()">Konfiguration speichern</button>
    </div>
  </div>

</body>

<script>
      // IP-Adresse abrufen und anzeigen
    async function ladeIP() {
      try {
        const res = await fetch("/ip");
        const ip = await res.text();
        document.getElementById("ipDisplay").textContent = "ESP32 IP-Adresse: " + ip;
      } catch (err) {
        console.error("Fehler beim Abrufen der IP:", err);
      }
    }

    // Dropdowns befüllen
    function befülleDropdown(id, start, end, step, noNull) {
      const el = document.getElementById(id);
      el.innerHTML = ""; // leeren
      for (let i = start; i <= end; i += step) {
        const opt = document.createElement("option");
        opt.value = i;
        if (opt.value == 256) opt.value = 255; // Kein 0-Wert
        opt.textContent = i;
        if (opt.textContent == 256) opt.textContent = 255; // Kein 0-Wert
        if (i > 0 && noNull)
          el.appendChild(opt);
        else if (!noNull)
          el.appendChild(opt);
      }
    }

    // Reaktion auf Radiobuttons
    function setFeldStatus(start, end, aktiv) {
      for (let i = start; i <= end; i++) {
        const el = document.getElementById(`d${i}`);
        if (el) el.disabled = !aktiv;
      }
    }

    // wird aufgerufen, wenn Radiobutton geändert wird
    document.addEventListener("DOMContentLoaded", () => {
      const radios = document.querySelectorAll('input[name="modus"]');
      radios.forEach(radio => {
        radio.addEventListener("click", () => {
          const modus = radio.value;

          // Standard: alles aktivieren
          setFeldStatus(1, 9, true);
          // effekte
          if (modus === "Mode 2") {
            setFeldStatus(1, 6, false); // Felder 1–6 deaktivieren
            // Test
          } else if (modus === "Mode 3") {
            setFeldStatus(1, 3, false); // Felder 1–3 deaktivieren
          }
        });
      });
    });

    // Neue Werte laden
    document.getElementById("d1").addEventListener("change", async function () {
      const index = this.value;
      if (!index) return;

      // Hauptkonfiguration laden
      try {
        const res1 = await fetch("/konfig?index=" + index);
        if (res1.ok) {
          const haupt = await res1.json();
          for (const key in haupt) {
            const el = document.getElementById(key);
            if (el) el.value = haupt[key];
          }
        } else {
          console.warn("Hauptkonfiguration nicht gefunden für Index " + index);
        }

        // Globale Extrawerte laden
        const res2 = await fetch("/extra");
        if (res2.ok) {
          const extra = await res2.json();
          for (const key in extra) {
            const el = document.getElementById(key);
            if (el) {
              el.value = extra[key];
            } else {
              // Radiobuttons setzen
              const radios = document.querySelectorAll(`input[name="${key}"]`);
              radios.forEach(r => r.checked = (r.value === extra[key]));
            }
          }
        } else {
          console.warn("Globale Extrawerte nicht gefunden");
        }
      } catch (err) {
        console.error("Fehler beim Laden der Konfiguration:", err);
      }
    });

    // Neue Werte speichern
    async function speichereKonfiguration() {
      const d1 = document.getElementById("d1").value;
      if (!d1) {
        alert("Bitte zuerst einen Index (d1) wählen.");
        return;
      }

      // Hauptkonfiguration: Felder d2–d3 + Radiobutton "modus"
      const haupt = { d1 }; // Index mitgeben
      for (let i = 2; i <= 3; i++) {
        const el = document.getElementById("d" + i);
        if (el) haupt["d" + i] = el.value;
      }

      // Extrawerte: Felder d4 und d8 (global gültig)
      const extra = {};
      for (let i = 4; i <= 8; i++) {
        const el = document.getElementById("d" + i);
        if (el) extra["d" + i] = el.value;
      }

      const selectedModus = document.querySelector('input[name="modus"]:checked');
      if (selectedModus) {
        extra["modus"] = selectedModus.value;
      }

      try {
        // Hauptkonfiguration speichern
        const res1 = await fetch("/speichern", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(haupt)
        });

        // Extrawerte speichern
        const res2 = await fetch("/speichern_extra", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(extra)
        });

      } catch (err) {
        console.error("Speicherfehler:", err);
        alert("Verbindungsfehler beim Speichern.");
      }
    }

    // Beim Laden ausführen
    window.onload = async function () {
      // Felder befüllen
      befülleDropdown("d1", 0, 95, 1, true);  // Raum
      befülleDropdown("d2", 0, 24, 1, true);  // ontime
      befülleDropdown("d3", 0, 24, 1, true);  // offtime
      befülleDropdown("d4", 0, 256, 4, false); // Rot
      befülleDropdown("d5", 0, 256, 4, false); // Grün
      befülleDropdown("d6", 0, 256, 4, false); // Blau
      befülleDropdown("d7", 500, 50000, 500, true);  // Zeitfaktor
      befülleDropdown("d8", 0, 95, 4, true);  // genutzte LED

      await ladeIP(); // IP anzeigen
      const indexFeld = document.getElementById("d1");
      if (!indexFeld || indexFeld.value === "") {
        console.warn("Kein Index für Konfiguration gesetzt");
        return;
      }

      // Hauptkonfiguration laden
      const res1 = await fetch("/konfig?index=" + indexFeld.value);
      if (res1.ok) {
        const haupt = await res1.json();
        for (const key in haupt) {
          const el = document.getElementById(key);
          // Felder setzen
          if (el) el.value = haupt[key];
        }
      }

      // Zusatzkonfiguration laden
      const res2 = await fetch("/extra");
      if (res2.ok) {
        const extra = await res2.json();
        for (const key in extra) {
          const el = document.getElementById(key);
          if (el) {
            el.value = extra[key];
          } else {
            const radios = document.querySelectorAll(`input[name="${key}"]`);
            radios.forEach(r => r.checked = (r.value === extra[key]));
          }
        }
      }
    };

</script>

</html>